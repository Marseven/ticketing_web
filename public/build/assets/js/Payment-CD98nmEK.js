import{ax as Z,D as $,b as s,d as l,e as o,i as g,g as E,q as M,h as ee,t as m,j as te,n as j,f as oe,v as re,A as C,$ as ae,U as ne,r as c,c as D,o as se,a as le,B as ie,N as de}from"./vue-vendor-wiowK_YT.js";import{_ as ue,u as ce}from"./account-CYVf-4X6.js";import"./vendor-14XLBY50.js";import"./pinia-vendor-xH9DYcoO.js";const me={name:"Payment",components:{ExclamationCircleIcon:$,ChevronLeftIcon:Z},setup(){const A=ie(),e=de(),I=ce(),t=c(!0),k=c(""),v=c(null),i=c(""),b=c(""),f=c(""),a=c(""),S=c(!1),P=c(!1),w=c(90),p=c(null),y=c(null),h=c(""),u=c(null),U=D(()=>I.isAuthenticated),N=D(()=>i.value?i.value==="airtel"||i.value==="moov"?!!b.value&&!f.value:i.value==="visa":!1),F=r=>new Intl.NumberFormat("fr-FR").format(r),R=async()=>{try{t.value=!0,k.value="";const r=A.params.reference;if(!r)throw new Error("Référence de commande manquante");const d=await fetch(`/api/v1/orders/${r}`,{headers:{Accept:"application/json",Authorization:`Bearer ${localStorage.getItem("token")||""}`}});if(!d.ok)throw new Error("Commande introuvable");const n=await d.json();v.value=n.data.order,v.value.status!=="pending"&&(k.value="Cette commande ne peut pas être payée (statut: "+v.value.status+")")}catch(r){console.error("Erreur chargement commande:",r),k.value=r.message||"Erreur lors du chargement de la commande"}finally{t.value=!1}},z=r=>{i.value=r,b.value="",f.value=""},L=()=>{const r=b.value,d=i.value;if(f.value="",!!r){if(d==="airtel"){const n=["074","076","077"];r.length===9&&/^[0-9]+$/.test(r)&&n.some(_=>r.startsWith(_))||(f.value="Le numéro Airtel Money doit faire 9 chiffres et commencer par 074, 076 ou 077")}if(d==="moov"){const n=["060","062","065","066"];r.length===9&&/^[0-9]+$/.test(r)&&n.some(_=>r.startsWith(_))||(f.value="Le numéro Moov Money doit faire 9 chiffres et commencer par 060, 062, 065 ou 066")}}},q=async()=>{try{if(S.value=!0,a.value="",!N.value)throw new Error("Veuillez remplir tous les champs requis");if(i.value==="airtel"||i.value==="moov")await K();else if(i.value==="visa")await W();else throw new Error("Méthode de paiement non supportée")}catch(r){console.error("Erreur paiement:",r),a.value=r.message||"Erreur lors du traitement du paiement"}finally{S.value=!1}},K=async()=>{try{const r={order_id:v.value.id,gateway:i.value==="airtel"?"airtelmoney":"moovmoney",phone:b.value,amount:v.value.total_amount},n=await(await fetch("/api/v1/payments/initiate",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")},body:JSON.stringify(r)})).json();if(!n.success)throw new Error(n.message||"Erreur lors de l'initiation du paiement");if(n.data?.bill_id){const _=await(await fetch("/api/v1/payments/push-ussd",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")},body:JSON.stringify({payment_id:n.data.payment.id,bill_id:n.data.bill_id,phone:b.value,gateway:i.value==="airtel"?"airtelmoney":"moovmoney"})})).json();if(_.success)V({payment_id:n.data.payment.id,reference:v.value.reference,phone:b.value,gateway:i.value==="airtel"?"airtelmoney":"moovmoney",amount:v.value.total_amount,bill_id:n.data.bill_id,payment_url:n.data.payment_url});else throw new Error(_.message||"Erreur lors de l'envoi du push USSD")}else throw new Error("Erreur lors de la création de la facture E-Billing")}catch(r){throw console.error("Erreur E-Billing:",r),r}},W=async()=>{try{const r={order_id:v.value.id,gateway:"ORABANK_NG",amount:v.value.total_amount},n=await(await fetch("/api/v1/payments/initiate",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")},body:JSON.stringify(r)})).json();if(n.success&&n.data?.redirect_url)window.location.href=n.data.redirect_url;else throw new Error(n.message||"Erreur lors de l'initiation du paiement Visa/Mastercard")}catch(r){throw console.error("Erreur ORABANK:",r),r}},V=r=>{P.value=!0,w.value=90,h.value="pending",u.value=r,O(),T(r.payment_id)},O=()=>{p.value&&clearInterval(p.value),p.value=setInterval(()=>{w.value--,w.value<=0&&(clearInterval(p.value),clearInterval(y.value),h.value="expired")},1e3)},T=r=>{y.value&&clearInterval(y.value),y.value=setInterval(async()=>{try{const d=await fetch(`/api/v1/payments/${r}/status`,{headers:{Accept:"application/json",Authorization:`Bearer ${localStorage.getItem("token")||""}`}});if(d.ok){const x=(await d.json()).data?.payment?.status;x==="success"||x==="successful"?(h.value="successful",clearInterval(y.value),clearInterval(p.value),setTimeout(()=>{e.push(`/ticket-success?reference=${u.value.reference}`)},2e3)):(x==="failed"||x==="cancelled"||x==="expired")&&(h.value=x,clearInterval(y.value),clearInterval(p.value),setTimeout(()=>{B()},3e3))}}catch(d){console.error("Erreur vérification statut:",d)}},3e3)},B=()=>{P.value=!1,w.value=90,h.value="",u.value=null,p.value&&clearInterval(p.value),y.value&&clearInterval(y.value)},X=async()=>{if(u.value)try{S.value=!0;const r=await fetch("/api/v1/payments/push-ussd",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${localStorage.getItem("token")||""}`},body:JSON.stringify({payment_id:u.value.payment_id,phone:u.value.phone,gateway:u.value.gateway})});if(r.ok)w.value=90,h.value="pending",O(),T(u.value.payment_id);else{const d=await r.json();a.value=d.message||"Erreur lors du renvoi du push"}}catch{a.value="Erreur de connexion"}finally{S.value=!1}},J=()=>{if(!u.value?.payment_url||!u.value?.bill_id){console.error("URL de paiement manquante");return}const r=`${u.value.payment_url}?invoice=${u.value.bill_id}`;window.location.href=r},G=()=>{P.value=!1,w.value=90,h.value="",u.value=null,p.value&&clearInterval(p.value),y.value&&clearInterval(y.value),i.value="",b.value=""},H=r=>{const d=Math.floor(r/60),n=r%60;return`${d}:${n.toString().padStart(2,"0")}`},Q=r=>r?r.replace(/(\d{3})(\d{2})(\d{2})(\d{2})/,"$1 $2 $3 $4"):"",Y=()=>{e.back()};return se(()=>{R()}),le(()=>{p.value&&clearInterval(p.value),y.value&&clearInterval(y.value)}),{loading:t,error:k,order:v,paymentMethod:i,phoneNumber:b,phoneError:f,paymentError:a,processingPayment:S,isAuthenticated:U,isFormValid:N,ussdPushActive:P,ussdCountdown:w,paymentStatus:h,currentPayment:u,formatPrice:F,loadOrder:R,selectPaymentMethod:z,validatePhoneNumber:L,processPayment:q,startUSSDPush:V,cancelUSSDPush:B,retryUSSDPush:X,payViaWebPage:J,changeOperator:G,formatCountdown:H,formatPhoneForDisplay:Q,goBack:Y}}},pe={class:"payment-page min-h-screen bg-gray-50 font-primea"},ye={class:"container mx-auto px-4 py-12"},ve={class:"max-w-2xl mx-auto"},be={class:"mb-12"},xe={class:"flex items-center justify-between mb-6"},fe={key:0,class:"text-center py-16"},he={key:1,class:"bg-red-50 border border-red-200 rounded-primea-xl p-8 text-center"},ge={class:"text-red-600 mb-4"},we={key:2,class:"space-y-8"},_e={class:"bg-white rounded-primea-xl shadow-primea p-8"},ke={class:"space-y-4 mb-6"},Se={class:"flex justify-between"},Pe={class:"font-mono font-bold text-primea-blue"},Ce={class:"flex justify-between"},Ee={class:"font-semibold"},Me={class:"flex justify-between"},je={class:"font-semibold"},Ae={class:"flex justify-between items-center pt-4 border-t-2 border-gray-200"},Ie={class:"text-3xl font-bold text-primea-blue"},Ne={class:"bg-white rounded-primea-xl shadow-primea p-8"},Re={class:"grid grid-cols-3 gap-4 mb-6"},Ve={key:0},Oe=["for"],Te=["id","placeholder"],Be={key:0,class:"mt-2 text-sm text-red-600"},De={key:1,class:"mt-2 text-sm text-gray-500"},Ue={key:1,class:"bg-blue-50 border border-blue-200 rounded-primea-lg p-4 text-center"},Fe={key:2,class:"bg-red-50 border-2 border-red-200 rounded-primea-lg p-4"},ze={class:"text-red-600 text-sm"},Le=["disabled"],qe={key:0,class:"flex items-center justify-center"},Ke={key:1},We={key:4,class:"bg-blue-50 border-2 border-blue-200 rounded-primea-xl p-6"},Xe={class:"text-center"},Je={key:0,class:"space-y-4"},Ge={class:"text-blue-700 mb-4"},He={class:"font-semibold"},Qe={class:"bg-white border border-blue-200 rounded-primea-lg p-4 mb-4"},Ye={class:"text-3xl font-bold text-blue-600 mb-2"},Ze={class:"w-full bg-blue-200 rounded-full h-2 mt-3"},$e={class:"text-blue-600 text-sm mb-4"},et={class:"font-semibold"},tt={class:"flex flex-col sm:flex-row gap-3 justify-center"},ot=["disabled"],rt={key:0},at={key:1},nt=["disabled"],st={key:1,class:"space-y-4"},lt={key:2,class:"space-y-4"},it={class:"text-red-700 mb-4"},dt={class:"flex flex-col sm:flex-row gap-3 justify-center"};function ut(A,e,I,t,k,v){const i=M("ChevronLeftIcon"),b=M("router-link"),f=M("ExclamationCircleIcon");return l(),s("div",pe,[o("div",ye,[o("div",ve,[o("div",be,[o("div",xe,[o("button",{onClick:e[0]||(e[0]=(...a)=>t.goBack&&t.goBack(...a)),class:"flex items-center text-primea-blue hover:text-primea-yellow transition-colors"},[E(i,{class:"w-6 h-6 mr-2"}),e[14]||(e[14]=o("span",{class:"font-medium"},"Retour",-1))]),E(b,{to:"/",class:"flex-1 flex justify-center"},{default:ee(()=>[...e[15]||(e[15]=[o("img",{src:"/images/logo.png",alt:"Primea",class:"h-16 hover:opacity-80 transition-opacity cursor-pointer"},null,-1)])]),_:1}),e[16]||(e[16]=o("div",{class:"w-24"},null,-1))]),e[17]||(e[17]=o("div",{class:"text-center"},[o("h1",{class:"text-4xl font-bold text-primea-blue mb-4"},"Finaliser le paiement"),o("p",{class:"text-lg text-gray-600"},"Sélectionnez votre mode de paiement")],-1))]),t.loading?(l(),s("div",fe,[...e[18]||(e[18]=[o("div",{class:"animate-spin rounded-full h-32 w-32 border-b-2 border-primea-blue mx-auto"},null,-1),o("p",{class:"mt-4 text-gray-600"},"Chargement...",-1)])])):t.error?(l(),s("div",he,[E(f,{class:"w-16 h-16 text-red-500 mx-auto mb-4"}),e[19]||(e[19]=o("h3",{class:"text-lg font-semibold text-red-800 mb-2"},"Erreur",-1)),o("p",ge,m(t.error),1),o("button",{onClick:e[1]||(e[1]=(...a)=>t.loadOrder&&t.loadOrder(...a)),class:"bg-primea-blue text-white px-6 py-2 rounded-primea hover:bg-primea-yellow hover:text-primea-blue transition-all duration-200"}," Réessayer ")])):t.order?(l(),s("div",we,[o("div",_e,[e[24]||(e[24]=o("h3",{class:"text-2xl font-bold text-primea-blue mb-6"},"Résumé de votre commande",-1)),o("div",ke,[o("div",Se,[e[20]||(e[20]=o("span",{class:"text-gray-600"},"Référence :",-1)),o("span",Pe,m(t.order.reference),1)]),o("div",Ce,[e[21]||(e[21]=o("span",{class:"text-gray-600"},"Événement :",-1)),o("span",Ee,m(t.order.event?.title||"N/A"),1)]),o("div",Me,[e[22]||(e[22]=o("span",{class:"text-gray-600"},"Nombre de billets :",-1)),o("span",je,m(t.order.quantity||t.order.tickets_count),1)]),o("div",Ae,[e[23]||(e[23]=o("span",{class:"text-lg font-bold text-primea-blue"},"Total à payer :",-1)),o("span",Ie,m(t.formatPrice(t.order.total_amount))+" XAF",1)])])]),o("div",Ne,[e[39]||(e[39]=o("h3",{class:"text-2xl font-bold text-primea-blue mb-6"},"Mode de paiement",-1)),o("form",{onSubmit:e[13]||(e[13]=te((...a)=>t.processPayment&&t.processPayment(...a),["prevent"])),class:"space-y-6"},[o("div",Re,[o("button",{type:"button",onClick:e[2]||(e[2]=a=>t.selectPaymentMethod("airtel")),class:j(["p-4 rounded-primea-lg border-2 transition-all text-center flex flex-col items-center justify-center min-h-[80px]",t.paymentMethod==="airtel"?"border-red-500 bg-red-50":"border-gray-200 hover:border-gray-300"])},[...e[25]||(e[25]=[o("img",{src:"/images/am.png",alt:"Airtel Money",class:"h-8 w-auto",onerror:"this.style.display='none'; this.nextElementSibling.style.display='block'"},null,-1),o("div",{class:"text-red-600 font-bold text-sm",style:{display:"none"}},"airtel money",-1)])],2),o("button",{type:"button",onClick:e[3]||(e[3]=a=>t.selectPaymentMethod("moov")),class:j(["p-4 rounded-primea-lg border-2 transition-all text-center flex flex-col items-center justify-center min-h-[80px]",t.paymentMethod==="moov"?"border-orange-500 bg-orange-50":"border-gray-200 hover:border-gray-300"])},[...e[26]||(e[26]=[o("img",{src:"/images/mm.png",alt:"Moov Money",class:"h-8 w-auto",onerror:"this.style.display='none'; this.nextElementSibling.style.display='block'"},null,-1),o("div",{class:"bg-orange-500 text-white px-2 py-1 rounded text-xs font-bold",style:{display:"none"}},"Moov Money",-1)])],2),o("button",{type:"button",onClick:e[4]||(e[4]=a=>t.selectPaymentMethod("visa")),class:j(["p-4 rounded-primea-lg border-2 transition-all text-center flex flex-col items-center justify-center min-h-[80px]",t.paymentMethod==="visa"?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"])},[...e[27]||(e[27]=[o("img",{src:"/images/vm.png",alt:"Visa",class:"h-8 w-auto",onerror:"this.style.display='none'; this.nextElementSibling.style.display='block'"},null,-1),o("div",{class:"text-blue-600 font-bold text-sm",style:{display:"none"}},"VISA",-1)])],2)]),t.paymentMethod==="airtel"||t.paymentMethod==="moov"?(l(),s("div",Ve,[o("label",{for:`payment-${t.paymentMethod}`,class:"block text-sm font-semibold text-primea-blue mb-2"}," Numéro "+m(t.paymentMethod==="airtel"?"Airtel Money":"Moov Money"),9,Oe),oe(o("input",{id:`payment-${t.paymentMethod}`,type:"tel","onUpdate:modelValue":e[5]||(e[5]=a=>t.phoneNumber=a),placeholder:t.paymentMethod==="airtel"?"074123456":"062123456",class:"w-full px-4 py-3 border-2 border-gray-200 rounded-primea-lg focus:border-primea-blue focus:outline-none transition-colors font-primea",maxlength:9,pattern:"[0-9]{9}",required:"",onInput:e[6]||(e[6]=(...a)=>t.validatePhoneNumber&&t.validatePhoneNumber(...a))},null,40,Te),[[re,t.phoneNumber]]),t.phoneError?(l(),s("p",Be,m(t.phoneError),1)):(l(),s("p",De,m(t.paymentMethod==="airtel"?"Format: 074xxxxxx, 076xxxxxx ou 077xxxxxx":"Format: 060xxxxxx, 062xxxxxx, 065xxxxxx ou 066xxxxxx"),1))])):g("",!0),t.paymentMethod==="visa"?(l(),s("div",Ue,[...e[28]||(e[28]=[o("p",{class:"text-blue-800 mb-2 font-semibold"},"Paiement Visa sécurisé",-1),o("p",{class:"text-blue-600 text-sm"},"Vous allez être redirigé vers notre partenaire de paiement sécurisé",-1)])])):g("",!0),t.paymentError?(l(),s("div",Fe,[o("p",ze,m(t.paymentError),1)])):g("",!0),t.ussdPushActive?g("",!0):(l(),s("button",{key:3,type:"submit",disabled:t.processingPayment||!t.isFormValid,class:"w-full bg-primea-blue text-white py-4 px-6 rounded-primea-lg text-lg font-bold hover:bg-primea-yellow hover:text-primea-blue transition-all duration-200 shadow-primea-lg transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"},[t.processingPayment?(l(),s("span",qe,[...e[29]||(e[29]=[o("svg",{class:"w-6 h-6 mr-2 animate-spin",fill:"none",viewBox:"0 0 24 24"},[o("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4",class:"opacity-25"}),o("path",{fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z",class:"opacity-75"})],-1),C(" Traitement en cours... ",-1)])])):(l(),s("span",Ke,"Finaliser le paiement"))],8,Le)),t.ussdPushActive?(l(),s("div",We,[o("div",Xe,[t.paymentStatus==="pending"?(l(),s("div",Je,[e[34]||(e[34]=o("div",{class:"flex items-center justify-center mb-4"},[o("div",{class:"w-16 h-16 border-4 border-blue-300 border-t-blue-600 rounded-full animate-spin"})],-1)),e[35]||(e[35]=o("h4",{class:"text-xl font-bold text-blue-800 mb-2"},"Push envoyé !",-1)),o("p",Ge,[e[30]||(e[30]=C(" Un push USSD a été envoyé au numéro ",-1)),o("span",He,m(t.formatPhoneForDisplay(t.currentPayment?.phone)),1),e[31]||(e[31]=C(". Veuillez valider le paiement sur votre téléphone. ",-1))]),o("div",Qe,[o("div",Ye,m(t.formatCountdown(t.ussdCountdown)),1),e[32]||(e[32]=o("div",{class:"text-sm text-blue-500"},"Temps restant pour valider",-1)),o("div",Ze,[o("div",{class:"bg-blue-600 h-2 rounded-full transition-all duration-1000",style:ae({width:t.ussdCountdown/90*100+"%"})},null,4)])]),o("p",$e,[e[33]||(e[33]=C(" Montant: ",-1)),o("span",et,m(t.formatPrice(t.order.total_amount))+" XAF",1)]),o("div",tt,[o("button",{type:"button",onClick:e[7]||(e[7]=(...a)=>t.retryUSSDPush&&t.retryUSSDPush(...a)),disabled:t.processingPayment||t.ussdCountdown>0,class:"bg-blue-600 text-white px-4 py-2 rounded-primea hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"},[t.processingPayment?(l(),s("span",rt,"Envoi...")):(l(),s("span",at,"Renvoyer le push"))],8,ot),t.currentPayment.payment_url&&t.currentPayment.bill_id?(l(),s("button",{key:0,type:"button",onClick:e[8]||(e[8]=(...a)=>t.payViaWebPage&&t.payViaWebPage(...a)),class:"bg-green-600 text-white px-4 py-2 rounded-primea hover:bg-green-700 transition-colors"}," Payer via page web ")):g("",!0),o("button",{type:"button",onClick:e[9]||(e[9]=(...a)=>t.changeOperator&&t.changeOperator(...a)),disabled:t.ussdCountdown>0,class:"bg-gray-500 text-white px-4 py-2 rounded-primea hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"}," Changer d'opérateur ",8,nt),o("button",{type:"button",onClick:e[10]||(e[10]=(...a)=>t.cancelUSSDPush&&t.cancelUSSDPush(...a)),class:"bg-red-500 text-white px-4 py-2 rounded-primea hover:bg-red-600 transition-colors"}," Annuler ")])])):t.paymentStatus==="successful"?(l(),s("div",st,[...e[36]||(e[36]=[ne('<div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4" data-v-4618f900><svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-4618f900><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" data-v-4618f900></path></svg></div><h4 class="text-xl font-bold text-green-800 mb-2" data-v-4618f900>Paiement réussi !</h4><p class="text-green-700 mb-4" data-v-4618f900>Votre paiement a été validé avec succès.</p><p class="text-green-600 text-sm" data-v-4618f900>Redirection en cours...</p>',4)])])):t.paymentStatus==="failed"||t.paymentStatus==="cancelled"||t.paymentStatus==="expired"?(l(),s("div",lt,[e[37]||(e[37]=o("div",{class:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"},[o("svg",{class:"w-8 h-8 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})])],-1)),e[38]||(e[38]=o("h4",{class:"text-xl font-bold text-red-800 mb-2"},"Paiement échoué",-1)),o("p",it,m(t.paymentStatus==="cancelled"?"Le paiement a été annulé.":t.paymentStatus==="expired"?"Le délai de paiement a expiré.":"Le paiement a échoué. Veuillez réessayer."),1),o("div",dt,[o("button",{type:"button",onClick:e[11]||(e[11]=(...a)=>t.retryUSSDPush&&t.retryUSSDPush(...a)),class:"bg-blue-600 text-white px-4 py-2 rounded-primea hover:bg-blue-700 transition-colors"}," Réessayer "),o("button",{type:"button",onClick:e[12]||(e[12]=(...a)=>t.changeOperator&&t.changeOperator(...a)),class:"bg-gray-500 text-white px-4 py-2 rounded-primea hover:bg-gray-600 transition-colors"}," Changer d'opérateur ")])])):g("",!0)])])):g("",!0)],32)])])):g("",!0)])])])}const vt=ue(me,[["render",ut],["__scopeId","data-v-4618f900"]]);export{vt as default};
